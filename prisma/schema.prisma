generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"

}

/**
 * Driving school staff users (login accounts)
 */
enum Role {
  SUPERADMIN
  ADMIN
  RECEPTION
  INSTRUCTOR
}

model User {
  id        String   @id @default(cuid())
  name      String
  username  String   @unique
  password  String
  role      Role     @default(RECEPTION)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// /** ✅ Vehicle classes */
// model VehicleClass {
//   id              Int      @id @default(autoincrement())
//   code            String   @unique
//   name            String
//   createdAt       DateTime @default(now())

//   applications     ApplicationVehicleClass[]
//   existingLicenses ExistingLicenseVehicleClass[]
// }

// /** ✅ Main student application */
// model StudentApplication {
//   id          String   @id @default(cuid())

//   referenceNo String   @unique
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt

//   fullName    String
//   nic         String   @unique
//   address     String
//   email       String?
//   phone1      String
//   phone2      String?

//   dateOfBirth DateTime
//   ageAtApply  Int

//   notes       String?  @db.Text

//   vehicleClasses  ApplicationVehicleClass[]
//   medical         MedicalExam?
//   existingLicense ExistingLicense?
//   fee             FeeSummary?
// }

// /** ✅ Many-to-many: application <-> vehicle classes */
// model ApplicationVehicleClass {
//   id             String @id @default(cuid())

//   applicationId  String
//   vehicleClassId Int

//   application    StudentApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
//   vehicleClass   VehicleClass       @relation(fields: [vehicleClassId], references: [id], onDelete: Restrict)

//   @@unique([applicationId, vehicleClassId])
// }

// /** ✅ Medical */
// enum MedicalStatus {
//   NOT_REQUIRED
//   PENDING
//   PASSED
//   FAILED
//   RE_MEDICAL_REQUIRED
// }

// model MedicalExam {
//   id             String @id @default(cuid())
//   applicationId  String @unique

//   status         MedicalStatus @default(PENDING)
//   medicalAt      DateTime?
//   reMedicalAt    DateTime?

//   application    StudentApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
// }

// /** ✅ Existing license */
// model ExistingLicense {
//   id             String @id @default(cuid())
//   applicationId  String @unique

//   licenseNo      String
//   issuedAt       DateTime?

//   /**
//    * ✅ IMPORTANT FIX:
//    * Opposite relation field for ExistingLicenseVehicleClass
//    */
//   classes        ExistingLicenseVehicleClass[]

//   /**
//    * Optional text field (you can keep it or remove it)
//    * If you use checkbox classes, you can remove classesText.
//    */
//   classesText    String?

//   application    StudentApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
// }

// /** ✅ Many-to-many: ExistingLicense <-> VehicleClass */
// model ExistingLicenseVehicleClass {
//   id                String @id @default(cuid())
//   existingLicenseId String
//   vehicleClassId    Int

//   existingLicense ExistingLicense @relation(fields: [existingLicenseId], references: [id], onDelete: Cascade)
//   vehicleClass     VehicleClass    @relation(fields: [vehicleClassId], references: [id], onDelete: Restrict)

//   @@unique([existingLicenseId, vehicleClassId])
// }

// /** ✅ Fees */
// enum FeeStatus {
//   UNPAID
//   PARTIAL
//   PAID
// }

// model FeeSummary {
//   id             String   @id @default(cuid())
//   applicationId  String   @unique

//   totalFee       Decimal  @db.Decimal(10,2)
//   advanceFee     Decimal  @db.Decimal(10,2)
//   balanceFee     Decimal  @db.Decimal(10,2)

//   status         FeeStatus @default(UNPAID)

//   createdAt      DateTime @default(now())
//   updatedAt      DateTime @updatedAt

//   application    StudentApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
// }


model StudentApplication {
  id            String   @id @default(cuid())
  referenceNo   String   @unique
  fullName      String
  nic           String
  address       String
  email         String?
  phone1        String
  phone2        String?
  dob           DateTime
  age           Int

  // Relations
  vehicleClasses   ApplicationVehicleClass[]
  existingLicense  ExistingLicense?

  notes            String?
 
 medicalDate     DateTime?
medicalTime     DateTime?
  medicalStatus   String   @default("PENDING")
  
 paymentInfo     PaymentInfo?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ApplicationVehicleClass {
  id        Int                 @id @default(autoincrement())

  applicationId String
  vehicleClassId Int

  application   StudentApplication @relation(fields: [applicationId], references: [id])
  vehicleClass  VehicleClass       @relation(fields: [vehicleClassId], references: [id])
}


model VehicleClass {
  id      Int      @id @default(autoincrement())
  code    String   @unique
  name    String
  createdAt DateTime @default(now())

  applications ApplicationVehicleClass[]
  existingLicenses ExistingLicenseVehicleClass[]
}

model ExistingLicense {
  id             Int      @id @default(autoincrement())
  applicationId  String   @unique

  licenseNumber  String?
  issuedDate     DateTime?
  vehicleClasses ExistingLicenseVehicleClass[]

  application    StudentApplication @relation(fields: [applicationId], references: [id])
}

model ExistingLicenseVehicleClass {
  id             Int      @id @default(autoincrement())

  licenseId      Int
  vehicleClassId Int

  license        ExistingLicense @relation(fields: [licenseId], references: [id])
  vehicleClass   VehicleClass    @relation(fields: [vehicleClassId], references: [id])
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

model PaymentInfo {
  id              Int      @id @default(autoincrement())
  applicationId   String   @unique

  totalFee        Int
  advanceFee      Int
  status          String   @default("PENDING")
  paidDate        DateTime? // optional if needed later

  application     StudentApplication @relation(fields: [applicationId], references: [id])
}
